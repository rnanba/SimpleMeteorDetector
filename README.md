# Simple Meteor Detector v0.1

## 概要

写真または動画から流星を検出するツールです。tail-feather さんの「OpenCVの直線検知で流星群画像を仕分け」( https://gist.github.com/tail-feather/d32d9ec125ba28c4a65b28fb74d7d00f ) をベースに改造したものです。

検出結果は JSON ファイルに出力します。動画から検出した場合、このファイルを利用して流星が流れた部分を集めたダイジェスト動画を生成できます。

## 動作環境

Python 3 と OpenCV が動く環境で動作します。
以下の環境で動作確認をしています。

- Ubuntu 20.04 LTS
- Anaconda 4.11
  - Python 3.7
  - OpenCV 3.4
  - FFMPEG 4.0

## 使い方の概要

### 写真の場合

1. 撮影した写真(JPEG)をディレクトリにコピーします。
   - 各写真は恒星の動きが十分小さく点に写っている必要があります。
2. 流星が写っている写真を一つ見つけるか、あるいは撮影した写真を全て比較明合成した画像を用意します。
3. detector_tuner.py で 2 の画像を処理して結果画像を確認します。
4. 結果画像に不満があればコマンドライン引数でパラメータを調整して 3 を繰り返します。
5. detect_meteor.py に 4 で調整したパラメータと 1 のディレクトリを指定して流星を検出します
6. コンソール出力または結果ファイルに書かれたファイル名を見て流星が写っている写真を選びます。

### 動画の場合

1. lighten_only_composite.py で撮影した動画の全フレームを比較明合成した画像を得ます。
   - 赤道儀で追尾撮影、または撮影時間が短く、恒星の動きが十分小さい場合です。
   - 恒星の動きが大きい場合は 2, 3 では流星の写っている部分をキャプチャーした画像を使います。
2. detector_tuner.py で 1 の画像を処理して結果画像を確認します。
3. 結果画像に不満があればコマンドライン引数でパラメータを調整して 2 を繰り返します。
4. detect_meteor.py に 3 で調整したパラメータと動画をを指定して流星を検出します。
5. make_digest_movie.py で結果ファイルを処理して流星が流れている部分だけを抜き出したダイジェスト動画を生成します。

## 各コマンドの使い方

### lighten_only_composite.py

動画の全フレームの比較明合成を行うためのコマンドです。

```
python lighten_only_composite.py input_video_file output_image_file
```

| 引数                  | 説明                                                  |
|-----------------------|-------------------------------------------------------|
| `input_video_file`	| 撮影した動画ファイルです。				|
| `output_image_file`	| 比較明合成の結果の出力先のファイルです。		|

`output_image_file` の拡張子


### detector_tuner.py

流星の写った画像を使って流星検出とマーク描画を試すためのコマンドです。

```
python detector_tuner.py input_image_file
```

| 引数                  | 説明                                                  |
|-----------------------|-------------------------------------------------------|
| `input_image_file`	| 流星の写った画像ファイルです。		        |

`input_image_file` には流星の写った画像ファイルを指定します。赤道儀で追尾撮影した動画の場合は lighten_only_composite.py の出力を使うとよいでしょう。

detector_tuner.py が正常に終了すると、コンソールに JSON 形式のパラメータを出力します(`--output-config-file` を指定しなかった場合)。また、以下のファイルを出力します。

| 出力ファイル          | 説明                                                  |
|-----------------------|-------------------------------------------------------|
| *入力画像のファイル名(拡張子なし)*_detect.png | 入力画像に検出した流星を囲むマーカーを描画した画像です。|
| *入力画像のファイル名(拡張子なし)*_threshold.png | 入力画像を二値化した画像です。|
| *入力画像のファイル名(拡張子なし)*_detect_threshold.png | 入力画像を二値化した画像に検出した流星を囲むマーカーを描画した画像です。|

二値化や検出基準のパラメータ、マーカーの描画パラメータなどはコマンドラインオプションで指定します。コマンドラインオプションには以下のものがあります。

| 引数                  | 説明                                                  |
|-----------------------|-------------------------------------------------------|
| `--background-threshold` *BACKGROUND_THRESHOLD* | 流星検出の前処理で画像を二値化する際の輝度の閾値です。0から255の整数値を指定します。省略すると自動的に検出した背景レベルを適用します。|
| `--min-line-length` *MIN_LINE_LENGTH* | 流星として検知する直線の最低の長さです。単位はピクセルです。|
| `--max-line-gap` *MAX_LINE_GAP* | 流星の直線が途切れている場合に許容する隙間の長さです。単位はピクセルです。|
| `--marker-color` *MARKER_COLOR* | マカーカーの色を指定します。色の書式は「(*R*,*G*,*B*)」または「(*R*,*G*,*B*,*A*)」形式で、*R*,*G*,*B*,*A* には0から255の整数値を指定します。*A* はアルファチャンネルの値で、255で不透明、0で透明、その間の値は半透明になります。|
| `--marker-thickness` *MARKER_THICKNESS* | マーカーの線の太さを指定します。単位はピクセルです。|
| `--output-config-file` *OUTPUT_CONFIG_FILE* | 適用されたパラメータ値の出力先のJSONファイルのファイル名を指定します。このオプションを指定するとコンソールにはパラメータ値は出力しません。|

